var currentModel=null;(function(){if(user()===null){getUser()}$("#create-topic-submit").on("click",function(a){a.preventDefault();$("#createtopic-form").submit()});$("#createtopic-form").validate({debug:true,rules:{title:{minlength:2,maxlength:100,required:true},description:{minlength:30,maxlength:300,required:true},twitterName:{minlength:2,required:{depends:function(a){return !$("#twitterHashtag:empty")}}},twitterHashtag:{minlength:2,required:{depends:function(a){return !$("#twitterUsername:empty")}}},smsHashtag:{minlength:2,required:false}},highlight:function(a){$(a).closest(".form-group").removeClass("has-success").addClass("has-error");$(a).closest(".panel").removeClass("panel-default").addClass("panel-danger")},success:function(a){a.addClass("valid").closest(".form-group").removeClass("has-error").addClass("has-success");$(a).closest(".panel").removeClass("panel-danger").addClass("panel-default")},errorClass:"help-block",validClass:"help-block",submitHandler:function(a){console.log("Submit");currentModel.saveChanges();return false}})}());function EditTopicModel(b){var a=this;currentModel=a;a.title=ko.observable();a.shortDescription=ko.observable();a.id=ko.observable();a.ownerUserId=ko.observable();a.channels=ko.observableArray([]);signInMessage($("#loginMessage"));a.mode=ko.computed(function(){if(a.id()!==null){return"Edit Topic"}else{return"New Topic"}},a);a.isAdmin=ko.computed(function(){if(user()===null){return true}else{if(a.ownerUserId()!==user().id){return false}else{return true}}},a);a.templateToUse=function(c){return c.view}.bind(a);a.createWebChannel=function(c){return({type:"Web form",id:ko.observable(c),attr:{href:"#web-form-channel",idt:"web-form-channel"},view:"web-channel-template"})};a.createTwitterChannel=function(e,c,d){return({type:"Twitter",name:ko.observable(c),hashtag:ko.observable(d),id:ko.observable(e),attr:{href:"#twitter-channel",idt:"twitter-channel"},view:"twitter-channel-template"})};a.createTwilioChannel=function(e,c,d){return({type:"SMS",hashtag:ko.observable(d),phoneNumbers:ko.observable(c==null||c.length==0?null:c[0]),id:ko.observable(e),attr:{href:"#sms-channel",idt:"sms-channel"},view:"sms-channel-template"})};a.populateTopicFromJson=function(c){a.title(c.title);a.id(c.id);a.ownerUserId(c.ownerUserId);a.shortDescription(c.shortDescription)};a.populateChannelsFromJson=function(h){var j=[];var c=false;var e=false;var d=false;h.sort(keysrt("source"));for(var f in h){var g=h[f];if(g.source=="None"){j.push(a.createWebChannel(g.id));c=true}else{if(g.source=="Twitter"){j.push(a.createTwitterChannel(g.id,g.account.name,g.account.hashtag));e=true}else{if(g.source=="Twilio"){j.push(a.createTwilioChannel(g.id,g.account.phoneNumbers,g.account.hashtag));d=true}}}}if(!c){j.push(a.createWebChannel())}if(!e){j.push(a.createTwitterChannel())}if(!d){j.push(a.createTwilioChannel())}a.channels(j)};a.getTopicJsonData=function(){return{id:ko.toJS(a.id),title:ko.toJS(a.title),shortDescription:ko.toJS(a.shortDescription)}};a.getChannelsJsonData=function(){jsonChannelData=[];for(var c in a.channels()){var e=a.channels()[c];var d=null;if(e.type=="SMS"){d={source:"Twilio",id:ko.toJS(e.id),account:{hashtag:e.hashtag()||""}}}else{if(e.type=="Twitter"){d={source:"Twitter",id:ko.toJSON(e.id),account:{name:e.name()||"",hashtag:e.hashtag()||""}}}else{if(e.type=="Web form"){d={source:"None",id:ko.toJS(e.id),account:{}}}}}if(d!==null){jsonChannelData.push(d)}}console.log(JSON.stringify(jsonChannelData));return jsonChannelData};a.saveAuthenticatedChannels=function(){jQuery("#successStatus").showLoading();$.ajax({url:"api/channels?topicId="+a.id(),type:"POST",data:JSON.stringify(a.getChannelsJsonData()),contentType:"application/json; charset=utf-8",dataType:"json",async:true,success:function(c){a.populateChannelsFromJson(c);$("#successStatus").html("<div class='alert alert-success'> Successfully saved channels details. </div>");if(!/^\s*$/.test($("#twitterName").value)){a.refreshTweets()}if(!/^\s*$/.test($("#smsHashtag").value)){a.refreshSMS()}if(b==undefined&&a.id()!==null){window.location.href="dashboard.html?topicId="+a.id()}},error:function(c,f,d){var e="An error occured: "+f+". Please try again later";$("#successStatus").html("<div class='alert alert-danger'>"+e+"</div>");console.log("some error occured: ",d)},complete:function(){jQuery("#successStatus").hideLoading()}})};a.saveAuthenticatedTopic=function(){jQuery("#successStatus").showLoading();$.ajax({url:"api/topics",type:"POST",data:JSON.stringify(a.getTopicJsonData()),contentType:"application/json; charset=utf-8",dataType:"json",async:false,success:function(c){a.populateTopicFromJson(c);$("#successStatus").html("<div class='alert alert-success'> Successfully saved topic details. </div>");a.saveAuthenticatedChannels()},error:function(c,f,d){var e="An error occured: "+f+". Please try again later";$("#successStatus").html("<div class='alert alert-danger'>"+e+"</div>");console.log("some error occured: ",d)},complete:function(){jQuery("#successStatus").hideLoading()}})};a.saveChanges=function(){a.saveAuthenticatedTopic()};a.deleteTopic=function(){function c(){jQuery("#successStatus").showLoading();$.ajax({url:"api/topics?topicId="+a.id(),type:"DELETE",contentType:"application/json; charset=utf-8",dataType:"json",async:true,success:function(d){jQuery("#successStatus").hideLoading();window.location.href="/"},error:function(d,g,e){var f="An error occured: "+g+". Please try again later";if(button!=undefined){$("#successStatus").html("<div class='alert alert-danger'>"+f+"</div>")}console.log("some error occured: ",e);jQuery("#successStatus").hideLoading()}})}showConfirmDialog("Are you sure you want to delete this topic? All the topic data will be deleted from our server.",c)};a.refreshTweets=function(c){function d(){if(c!=undefined){jQuery("#successStatus").showLoading()}$.ajax({url:"api/twitter",type:"GET",data:{topicId:a.id()},contentType:"application/json; charset=utf-8",dataType:"json",async:true,success:function(e){if(c!=undefined){$("#successStatus").html("<div class='alert alert-success'> Successfully fectched new tweets. </div>")}},error:function(e,h,f){var g="An error occured: "+h+". Please try again later";if(c!=undefined){$("#successStatus").html("<div class='alert alert-danger'>"+g+"</div>")}console.log("some error occured: ",f)},complete:function(){jQuery("#successStatus").hideLoading()}})}d()};a.refreshSMS=function(c){function d(){if(c!=undefined){jQuery("#successStatus").showLoading()}$.ajax({url:"api/twilio",type:"GET",data:{topicId:a.id()},contentType:"application/json; charset=utf-8",dataType:"json",async:true,success:function(e){if(c!=undefined){$("#successStatus").html("<div class='alert alert-success'> Successfully fetched outstanding SMS. </div>")}},error:function(e,h,f){var g="An error occured: "+h+". Please try again later";if(c!=undefined){$("#successStatus").html("<div class='alert alert-danger'>"+g+"</div>")}console.log("some error occured: ",f)},complete:function(){jQuery("#successStatus").hideLoading()}})}d()};if(b==undefined){a.channels.push(a.createWebChannel());a.channels.push(a.createTwitterChannel());a.channels.push(a.createTwilioChannel())}else{$.ajax({url:"api/topics",type:"GET",data:{topicId:b},contentType:"application/json; charset=utf-8",async:true,success:function(c){a.populateTopicFromJson(c);$.ajax({url:"api/channels",type:"GET",data:{topicId:b},contentType:"application/json; charset=utf-8",async:true,success:function(d){a.populateChannelsFromJson(d)},error:function(d,g,e){var f="We could not retrieved channels for topic with id "+b+" : "+g+". Please try again later";$("#successStatus").html("<div class='alert alert-danger'>"+f+"</div>");console.log("some error occured: ",e)}})},error:function(c,f,d){var e="We could not retrieved the topic with id "+b+" : "+f+". Please try again later";$("#successStatus").html("<div class='alert alert-danger'>"+e+"</div>");console.log("some error occured: ",d)}})}};